{"ast":null,"code":"import React,{useReducer,useEffect,useCallback}from\"react\";import _ from\"lodash\";// Make sure lodash is installed: `npm install lodash`\nimport{Streamlit}from\"streamlit-component-lib\";import{useRenderData}from\"../utils/StreamlitProvider\";import{initialState,reducer}from\"../reducers/highlightReducer\";import{isHighlighted,removeHighlight,getCharactersCountUntilNode,adjustSelectionBounds}from\"../helpers/highlightHelpers\";import{ActionTypes}from\"../types/highlightTypes\";import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const Highlighter=_ref=>{let{uniqueId}=_ref;const{args}=useRenderData();const[state,dispatch]=useReducer(reducer,initialState);// Debounce `Streamlit.setComponentValue` to reduce frequent re-renders\nconst debouncedSetComponentValue=useCallback(_.debounce(value=>Streamlit.setComponentValue(value),300),[]);useEffect(()=>{const fetchData=async()=>{const{text,highlights}=args;dispatch({type:ActionTypes.SET_TEXT_HIGHLIGHTS,payload:{text,highlights}});dispatch({type:ActionTypes.RENDER_TEXT});debouncedSetComponentValue(highlights);// Use debounced function here\n};fetchData();},[debouncedSetComponentValue,args]);useEffect(()=>{dispatch({type:ActionTypes.RENDER_TEXT});},[state.highlights,state.selectedReference]);// Debugging: Log component mounting and unmounting\nuseEffect(()=>{console.log(`Highlighter component with ID ${uniqueId} mounted`);return()=>{console.log(`Highlighter component with ID ${uniqueId} unmounted`);};},[uniqueId]);const handleMouseUp=useCallback(async()=>{var _document$getSelectio;const selection=(_document$getSelectio=document.getSelection())===null||_document$getSelectio===void 0?void 0:_document$getSelectio.getRangeAt(0);if(selection&&selection.toString().trim()!==\"\"){const container=document.getElementById(`actual-text-${uniqueId}`);const charsBeforeStart=getCharactersCountUntilNode(selection.startContainer,container);const charsBeforeEnd=getCharactersCountUntilNode(selection.endContainer,container);const finalStartIndex=selection.startOffset+charsBeforeStart;const finalEndIndex=selection.endOffset+charsBeforeEnd;const textContent=(container===null||container===void 0?void 0:container.textContent)||\"\";const{start,end}=adjustSelectionBounds(textContent,finalStartIndex,finalEndIndex);const selectedText=textContent.slice(start,end);if(isHighlighted(finalStartIndex,finalEndIndex,state.highlights[state.selectedReference])){const highlights=removeHighlight(start,end,state.highlights[state.selectedReference]);const newHighlights=[...state.highlights];newHighlights[state.selectedReference]=highlights;dispatch({type:ActionTypes.SET_TEXT_HIGHLIGHTS,payload:{text:state.text,highlights:newHighlights}});}else{const newHighlight={start,end,label:selectedText};const newHighlights=[...state.highlights];newHighlights[state.selectedReference]=[...newHighlights[state.selectedReference],newHighlight];dispatch({type:ActionTypes.SET_TEXT_HIGHLIGHTS,payload:{text:state.text,highlights:newHighlights}});}}},[state,dispatch,uniqueId]);const addReference=()=>{dispatch({type:ActionTypes.ADD_REFERENCE});};const selectReference=index=>{dispatch({type:ActionTypes.SELECT_REFERENCE,payload:index});};const removeReference=index=>{dispatch({type:ActionTypes.REMOVE_REFERENCE,payload:index});};return/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex flex-row flex-wrap\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"flex flex-wrap justify-between items-center cursor-pointer py-1 px-3 mr-2 mb-2 rounded text-white text-base bg-primary hover:bg-secondary\",onClick:addReference,children:/*#__PURE__*/_jsx(\"span\",{children:\"+\"})}),state.highlights.map((reference,index)=>/*#__PURE__*/_jsxs(\"span\",{className:\"flex flex-wrap justify-between items-center cursor-pointer py-1 px-3 mr-2 mb-2 rounded text-base\"+(state.selectedReference===index?\" bg-primary hover:bg-secondary text-white\":\" border border-primary text-primary hover:bg-primary hover:text-white\"),onClick:()=>selectReference(index),children:[index,/*#__PURE__*/_jsx(\"svg\",{xmlns:\"http://www.w3.org/2000/svg\",className:\"h-5 w-5 ml-3 hover:text-gray-300\",viewBox:\"0 0 20 20\",fill:\"currentColor\",onClick:()=>removeReference(index),children:/*#__PURE__*/_jsx(\"path\",{fillRule:\"evenodd\",d:\"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z\"})})]},`Evidence-${index}`))]}),/*#__PURE__*/_jsx(\"div\",{id:`actual-text-${uniqueId}`,className:\"mt-5 h-full\",onMouseUp:handleMouseUp,style:{whiteSpace:\"pre-wrap\"},children:state.actual_text})]});};export default Highlighter;","map":{"version":3,"names":["React","useReducer","useEffect","useCallback","_","Streamlit","useRenderData","initialState","reducer","isHighlighted","removeHighlight","getCharactersCountUntilNode","adjustSelectionBounds","ActionTypes","jsx","_jsx","jsxs","_jsxs","Highlighter","_ref","uniqueId","args","state","dispatch","debouncedSetComponentValue","debounce","value","setComponentValue","fetchData","text","highlights","type","SET_TEXT_HIGHLIGHTS","payload","RENDER_TEXT","selectedReference","console","log","handleMouseUp","_document$getSelectio","selection","document","getSelection","getRangeAt","toString","trim","container","getElementById","charsBeforeStart","startContainer","charsBeforeEnd","endContainer","finalStartIndex","startOffset","finalEndIndex","endOffset","textContent","start","end","selectedText","slice","newHighlights","newHighlight","label","addReference","ADD_REFERENCE","selectReference","index","SELECT_REFERENCE","removeReference","REMOVE_REFERENCE","children","className","onClick","map","reference","xmlns","viewBox","fill","fillRule","d","id","onMouseUp","style","whiteSpace","actual_text"],"sources":["/Users/narutatsuri/Downloads/streamlit_test/utils/highlighter/frontend/src/components/Highlighter.tsx"],"sourcesContent":["import React, { useReducer, useEffect, useCallback } from \"react\";\nimport _ from \"lodash\"; // Make sure lodash is installed: `npm install lodash`\nimport { Streamlit } from \"streamlit-component-lib\";\nimport { useRenderData } from \"../utils/StreamlitProvider\";\nimport { initialState, reducer } from \"../reducers/highlightReducer\";\nimport {\n  isHighlighted,\n  removeHighlight,\n  getCharactersCountUntilNode,\n  adjustSelectionBounds,\n} from \"../helpers/highlightHelpers\";\nimport { IState, ActionTypes, IAction } from \"../types/highlightTypes\";\n\nconst Highlighter: React.FC<{ uniqueId: string }> = ({ uniqueId }) => {\n  const { args } = useRenderData();\n  const [state, dispatch] = useReducer<React.Reducer<IState, IAction>>(\n    reducer,\n    initialState\n  );\n\n  // Debounce `Streamlit.setComponentValue` to reduce frequent re-renders\n  const debouncedSetComponentValue = useCallback(\n    _.debounce((value) => Streamlit.setComponentValue(value), 300),\n    []\n  );\n\n  useEffect(() => {\n    const fetchData = async () => {\n      const { text, highlights } = args;\n      dispatch({\n        type: ActionTypes.SET_TEXT_HIGHLIGHTS,\n        payload: { text, highlights },\n      });\n      dispatch({ type: ActionTypes.RENDER_TEXT });\n      debouncedSetComponentValue(highlights); // Use debounced function here\n    };\n\n    fetchData();\n  }, [debouncedSetComponentValue, args]);\n\n  useEffect(() => {\n    dispatch({ type: ActionTypes.RENDER_TEXT });\n  }, [state.highlights, state.selectedReference]);\n\n  // Debugging: Log component mounting and unmounting\n  useEffect(() => {\n    console.log(`Highlighter component with ID ${uniqueId} mounted`);\n    return () => {\n      console.log(`Highlighter component with ID ${uniqueId} unmounted`);\n    };\n  }, [uniqueId]);\n\n  const handleMouseUp = useCallback(async () => {\n    const selection = document.getSelection()?.getRangeAt(0);\n\n    if (selection && selection.toString().trim() !== \"\") {\n      const container = document.getElementById(`actual-text-${uniqueId}`);\n      const charsBeforeStart = getCharactersCountUntilNode(\n        selection.startContainer,\n        container\n      );\n      const charsBeforeEnd = getCharactersCountUntilNode(\n        selection.endContainer,\n        container\n      );\n\n      const finalStartIndex = selection.startOffset + charsBeforeStart;\n      const finalEndIndex = selection.endOffset + charsBeforeEnd;\n\n      const textContent = container?.textContent || \"\";\n\n      const { start, end } = adjustSelectionBounds(\n        textContent,\n        finalStartIndex,\n        finalEndIndex\n      );\n      const selectedText = textContent.slice(start, end);\n\n      if (\n        isHighlighted(\n          finalStartIndex,\n          finalEndIndex,\n          state.highlights[state.selectedReference]\n        )\n      ) {\n        const highlights = removeHighlight(\n          start,\n          end,\n          state.highlights[state.selectedReference]\n        );\n        const newHighlights = [...state.highlights];\n        newHighlights[state.selectedReference] = highlights;\n        dispatch({\n          type: ActionTypes.SET_TEXT_HIGHLIGHTS,\n          payload: { text: state.text, highlights: newHighlights },\n        });\n      } else {\n        const newHighlight = { start, end, label: selectedText };\n        const newHighlights = [...state.highlights];\n        newHighlights[state.selectedReference] = [\n          ...newHighlights[state.selectedReference],\n          newHighlight,\n        ];\n        dispatch({\n          type: ActionTypes.SET_TEXT_HIGHLIGHTS,\n          payload: { text: state.text, highlights: newHighlights },\n        });\n      }\n    }\n  }, [state, dispatch, uniqueId]);\n\n  const addReference = () => {\n    dispatch({ type: ActionTypes.ADD_REFERENCE });\n  };\n\n  const selectReference = (index: number) => {\n    dispatch({ type: ActionTypes.SELECT_REFERENCE, payload: index });\n  };\n\n  const removeReference = (index: number) => {\n    dispatch({ type: ActionTypes.REMOVE_REFERENCE, payload: index });\n  };\n\n  return (\n    <div>\n      <div className=\"flex flex-row flex-wrap\">\n        <div\n          className=\"flex flex-wrap justify-between items-center cursor-pointer py-1 px-3 mr-2 mb-2 rounded text-white text-base bg-primary hover:bg-secondary\"\n          onClick={addReference}\n        >\n          <span>+</span>\n        </div>\n        {state.highlights.map((reference, index) => (\n          <span\n            key={`Evidence-${index}`}\n            className={\n              \"flex flex-wrap justify-between items-center cursor-pointer py-1 px-3 mr-2 mb-2 rounded text-base\" +\n              (state.selectedReference === index\n                ? \" bg-primary hover:bg-secondary text-white\"\n                : \" border border-primary text-primary hover:bg-primary hover:text-white\")\n            }\n            onClick={() => selectReference(index)}\n          >\n            {index}\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              className=\"h-5 w-5 ml-3 hover:text-gray-300\"\n              viewBox=\"0 0 20 20\"\n              fill=\"currentColor\"\n              onClick={() => removeReference(index)}\n            >\n              <path\n                fillRule=\"evenodd\"\n                d=\"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z\"\n              />\n            </svg>\n          </span>\n        ))}\n      </div>\n      <div\n        id={`actual-text-${uniqueId}`}\n        className=\"mt-5 h-full\"\n        onMouseUp={handleMouseUp}\n        style={{ whiteSpace: \"pre-wrap\" }}\n      >\n        {state.actual_text}\n      </div>\n    </div>\n  );\n};\n\nexport default Highlighter;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}